# Lead AI CRM

Небольшой CRM-сервис для работы с лидами и продажами, в котором используется AI-оценка лида перед передачей в продажи.

Сервис реализован на:

- Python 3.12
- FastAPI
- Tortoise ORM + PostgreSQL
- Docker / Docker Compose

---

## Содержание

- [Запуск](#запуск)
- [Структура проекта](#структура-проекта)
- [Основные сущности](#основные-сущности)
- [Как работает система](#как-работает-система)
- [Где используется AI и почему](#где-используется-ai-и-почему)
- [Какие данные отдаются AI](#какие-данные-отдаются-ai)
- [Какие решения принимает человек](#какие-решения-принимает-человек)
- [Что бы я усложнила в реальном проекте](#что-бы-я-усложнила-в-реальном-проекте)

## Запуск

### Вариант 1. Через Docker Compose (рекомендуется)

Нужны только Docker и Docker Compose.

```bash
git clone https://github.com/machinatororis/lead-ai-crm.git
cd lead-ai-crm

docker compose up --build
```

После запуска:

* API доступно по адресу: ```http://localhost:8000```
* Healthcheck: ```http://localhost:8000/health```
* Swagger UI: ```http://localhost:8000/docs```

В Docker поднимаются два сервиса:

* ```db``` - PostgreSQL 16
* ```app``` - FastAPI приложение

Приложение подключается к БД через строку подключения из переменной окружения ```DB_URL```, которая задаётся в ```docker-compose.yml```:

```DB_URL=postgres://postgres:postgres@db:5432/lead_ai_crm```

### Вариант 2. Локальный запуск без Docker

#### 1. Клонировать репозиторий

```
git clone https://github.com/machinatororis/lead-ai-crm.git
cd lead-ai-crm
```

#### 2. Поднять PostgreSQL

Например, через Docker:
```
docker run --name lead-db \
  -e POSTGRES_DB=lead_ai_crm \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=postgres \
  -p 5432:5432 \
  -d postgres:16
```

#### 3. Настроить переменные окружения

Скопировать пример ```.env```:

```
cp .env.example .env
```

По умолчанию там:

```
DB_URL=postgres://postgres:postgres@localhost:5432/lead_ai_crm
```

#### 4. Установить зависимости и запустить приложение

```
python -m venv venv
# Windows:
venv\Scripts\activate
# Linux / macOS:
# source venv/bin/activate

pip install -r requirements.txt

uvicorn app.main:app --reload
```

После этого:

* Healthcheck: ```http://localhost:8000/health```
* Swagger UI: ```http://localhost:8000/docs```

## Структура проекта

```
app/
  api/
    leads.py          # API (FastAPI роутер для работы с лидами)
  services/
    ai_service.py     # AI-сервис: оценка лида
    lead_service.py   # Бизнес-логика работы с лидами и продажами
  models.py           # Модели Tortoise ORM (Lead, Sale)
  schemas.py          # Pydantic-схемы для API
  main.py             # Точка входа, инициализация FastAPI и Tortoise ORM
```

Разделение слоёв:

* API ```app/api/leads.py```
* Бизнес-логика ```app/services/lead_service.py```
* AI-сервис ```app/services/ai_service.py```

## Основные сущности

#### Lead

Холодный лид, который проходит этапы воронки:

```
new -> contacted -> qualified -> transferred / lost
```

#### Поля:

* ```source``` источник лида (scanner, partner, manual)
* ```stage``` текущий этап (new, contacted, qualified, transferred, lost)
* ```business_domain``` бизнес-домен лида (опционально)
* ```activity_count``` количество сообщений / активности по лиду
* ```ai_score``` AI-оценка вероятности сделки (0..1)
* ```ai_recommendation``` рекомендация AI (transfer_to_sales, continue_qualification, drop_lead)
* ```ai_reason``` текстовое объяснение решения AI

#### Основные эндпоинты

Все эндпоинты доступны под префиксом /leads (см. Swagger http://localhost:8000/docs
).

* ```POST /leads/``` создать лида
* ```GET /leads/{id}``` получить лида
* ```PATCH /leads/{id}/stage``` обновить стадию лида
* ```POST /leads/{id}/analyze``` запустить AI-оценку лида

## Как работает система

### 1. Создание лида

Менеджер создаёт лида через:

```POST /leads/```

Передаёт:

* ```source``` (обязателен)
* ```business_domain``` (если известен)

Новый лид создаётся с:

```
stage = "new"
activity_count = 0
ai_score = null
```

### 2. Нарастание активности

Поле ```activity_count``` хранит количество взаимодействий/сообщений с лидом.
* в реальной системе оно увеличивалось бы автоматически (по событиям),
* в тестовом проекте - через обновление в БД или дополнительный эндпоинт.

### 3. AI-оценка

Когда менеджер набрал достаточно информации, он вызывает:

```POST /leads/{id}/analyze```

Бизнес-слой ```(lead_service.analyze_lead_and_save)``` передаёт в AI-сервис параметры лида, сохраняет результат в:

```
ai_score
ai_recommendation
ai_reason
```

### 4. Движение по стадиям

Переходы по холодной воронке ограничены. 

Допустимы только переходы вперёд на один шаг:

```
new → contacted
contacted → qualified
qualified → transferred
```

* в ```lost``` можно перейти с любой не финальной стадии
* если лид уже в финальной стадии (```transferred``` или ```lost```), менять её нельзя

Эти правила реализованы в ```lead_service.is_valid_stage_transition```.

### 5. Передача в продажи

При переходе на стадию ```transferred``` проверяются условия ТЗ:

* ```ai_score >= 0.6```
* ```business_domain``` указан

Если условия не выполнены, то выбрасывается ошибка, и API отвечает ```400 Bad Request```.

Если выполнены, то создаётся объект ```Sale``` и лид получает ```stage = "transferred"```.

## Где используется AI и почему

AI-логика вынесена в отдельный модуль:

```app/services/ai_service.py```

Функция ```async def analyze_lead```.

AI принимает ключевые параметры лида, считает ```score``` (оценку от 0 до 1), выдает ```recommendation``` и текстовое объяснение.

AI сейчас без реальной ML-модели, в реальном проекте AI-модуль можно заменить на ML-модель или на внешний AI-сервис (LLM).

Вся остальная архитектура (API + бизнес-логика) от этого не поменяется.

#### Какие данные отдаются AI

В AI-сервис передаются только данные лида:

* ```source``` источник лида (scanner, partner, manual)
* ```stage``` текущий этап воронки
* ```activity_count``` количество сообщений
* ```business_domain``` бизнес-домен (или None, если неизвестен)

На основе этих четырёх параметров AI:

* вычисляет вероятность сделки ```(score)```
* даёт рекомендацию ```(recommendation)```
* формирует объяснение ```(reason)```

Результат записывается в поля Lead:
```
ai_score
ai_recommendation
ai_reason
```

## Какие решения принимает человек

Человек создаёт лида, проводит коммуникацию, решает, когда запускать AI-оценку, шаг за шагом перевозит лида по стадиям.
AI не переводит лида в продажи автоматически;

AI только считает оценку, рекомендует действие, ограничивает возможность передачи в продажи (через бизнес-правила).

Окончательное решение остаётся за человеком и бизнес-логикой, а не за AI.

## Что бы я усложнила в реальном проекте:

* логи, метрики, мониторинг


* можно сделать ml-модель, наученную на датасете исторических лидов и сделок
* гео/язык/сегмент клиента;
* время от создания лида до первого контакта;
* количество/плотность коммуникаций во времени;
* признаки по содержанию сообщений (NLP);


* асинхронную обработку и очереди
* авторизацию и роли, если этого требуют бизнесс процессы
* миграции